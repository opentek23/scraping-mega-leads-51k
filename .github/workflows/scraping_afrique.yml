name: ğŸŒ Scraping Afrique Auto - 17.8K Leads

on:
  schedule:
    - cron: '0 6,14,22 * * *'  # 3 runs par jour
  workflow_dispatch:
    inputs:
      target_leads:
        description: 'Objectif leads par run'
        required: false
        default: '1500'
      test_mode:
        description: 'Mode test (true/false)'
        required: false
        default: 'false'
      send_emails:
        description: 'Envoyer emails (true/false)'
        required: false
        default: 'true'

jobs:
  scraping-afrique:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install -r requirements.txt
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: ğŸ¯ Run Africa Mega Scraping
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RUN_NUMBER: ${{ github.run_number }}
        TARGET_LEADS: ${{ github.event.inputs.target_leads || '1500' }}
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
      run: |
        echo "ğŸš€ DÃ©marrage scraping Afrique..."
        echo "ğŸ¯ Objectif: $TARGET_LEADS leads"
        echo "âš™ï¸ Mode test: $TEST_MODE"
        python scripts/scraping_afrique_mega.py
        
    - name: ğŸ“§ Send Automated Emails
      if: always() && github.event.inputs.send_emails != 'false'
      env:
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
        SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL || 'contact@neolinks.me' }}
      run: |
        echo "ğŸ“§ DÃ©marrage automation email..."
        echo "ğŸ“¨ ExpÃ©diteur: $SENDER_EMAIL"
        python scripts/email_automation.py
        
    - name: ğŸ“Š Upload Results as Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: afrique-leads-run-${{ github.run_number }}
        path: |
          data/
        retention-days: 90
        if-no-files-found: warn
        
    - name: ğŸ“ˆ Display Results Summary
      if: always()
      run: |
        echo "ğŸ“Š Run #${{ github.run_number }} terminÃ©"
        echo "ğŸ“… $(date)"
        echo "ğŸ”— RÃ©sultats disponibles dans les Artifacts"
        
        # Afficher le contenu du dossier data
        if [ -d "data" ]; then
          echo "ğŸ“ Fichiers gÃ©nÃ©rÃ©s:"
          ls -la data/
          
          # Afficher un aperÃ§u des stats si disponible
          if ls data/stats_*.json 1> /dev/null 2>&1; then
            echo "ğŸ“Š AperÃ§u des statistiques:"
            cat data/stats_*.json | head -20
          fi
          
          # Afficher rapport email si disponible
          if ls data/email_report_*.json 1> /dev/null 2>&1; then
            echo "ğŸ“§ Rapport email:"
            cat data/email_report_*.json | head -10
          fi
        else
          echo "âš ï¸ Aucun fichier gÃ©nÃ©rÃ© dans le dossier data"
        fi
