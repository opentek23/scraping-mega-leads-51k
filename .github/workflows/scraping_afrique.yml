name: ğŸŒ Scraping Afrique OptimisÃ© - SANS EMAIL
on:
  schedule:
    - cron: '0 6,14,22 * * *'  # 3 runs par jour Ã  6h, 14h, 22h UTC
  workflow_dispatch:
    inputs:
      target_leads:
        description: 'Objectif leads par run'
        required: false
        default: '100'
        type: string
      test_mode:
        description: 'Mode test (true/false)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      countries_limit:
        description: 'Nombre de pays Ã  scraper'
        required: false
        default: '6'
        type: string

jobs:
  scraping-afrique:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # RÃ©duit pour Ã©viter timeouts
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4 lxml selenium
        pip install pandas numpy python-dateutil
        
    - name: ğŸŒ Scraping Africa Mega Leads
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RUN_NUMBER: ${{ github.run_number }}
        TARGET_LEADS: ${{ github.event.inputs.target_leads || '100' }}
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        COUNTRIES_LIMIT: ${{ github.event.inputs.countries_limit || '6' }}
      run: |
        echo "ğŸš€ SCRAPING AFRIQUE SANS EMAIL - RUN #$RUN_NUMBER"
        echo "ğŸ¯ Objectif: $TARGET_LEADS leads"
        echo "âš™ï¸ Mode test: $TEST_MODE"
        echo "ğŸŒ Pays limitÃ©s: $COUNTRIES_LIMIT"
        echo "ğŸ“… DÃ©marrage: $(date)"
        
        # CrÃ©er le dossier data
        mkdir -p data
        
        # Lancer le scraping seul
        python scripts/scraping_afrique_mega.py
        
        echo "âœ… Scraping terminÃ© Ã  $(date)"
        
    - name: ğŸ“Š VÃ©rification des rÃ©sultats
      run: |
        echo "ğŸ“Š VÃ‰RIFICATION RÃ‰SULTATS - RUN #${{ github.run_number }}"
        
        if [ -d "data" ]; then
          echo "ğŸ“ Contenu du dossier data:"
          ls -la data/
          
          # Compter les fichiers CSV gÃ©nÃ©rÃ©s
          csv_count=$(find data/ -name "*.csv" | wc -l)
          echo "ğŸ“„ Fichiers CSV: $csv_count"
          
          # Afficher les statistiques si disponibles
          if ls data/stats_*.json 1> /dev/null 2>&1; then
            echo ""
            echo "ğŸ“Š STATISTIQUES DÃ‰TAILLÃ‰ES:"
            latest_stats=$(ls -t data/stats_*.json | head -1)
            cat "$latest_stats"
          fi
          
          # Afficher aperÃ§u du CSV principal
          if ls data/afrique_8_cibles_*.csv 1> /dev/null 2>&1; then
            echo ""
            echo "ğŸ“ˆ APERÃ‡U DONNÃ‰ES CSV:"
            latest_csv=$(ls -t data/afrique_8_cibles_*.csv | head -1)
            echo "Fichier: $latest_csv"
            echo "Lignes totales: $(wc -l < "$latest_csv")"
            echo "Colonnes: $(head -1 "$latest_csv")"
            echo ""
            echo "Premiers prospects:"
            head -5 "$latest_csv"
          fi
        else
          echo "âŒ Aucun dossier data crÃ©Ã©"
          exit 1
        fi
        
    - name: ğŸ” Validation qualitÃ© des donnÃ©es
      run: |
        echo "ğŸ” VALIDATION QUALITÃ‰ DONNÃ‰ES"
        
        # VÃ©rifier la qualitÃ© des emails
        if ls data/afrique_8_cibles_*.csv 1> /dev/null 2>&1; then
          latest_csv=$(ls -t data/afrique_8_cibles_*.csv | head -1)
          
          # Compter emails valides
          valid_emails=$(tail -n +2 "$latest_csv" | cut -d',' -f3 | grep -E "^[^,]*@[^,]*\.[^,]*$" | wc -l)
          total_lines=$(tail -n +2 "$latest_csv" | wc -l)
          
          echo "ğŸ“§ Emails valides: $valid_emails / $total_lines"
          
          # VÃ©rifier rÃ©partition par pays
          echo ""
          echo "ğŸŒ RÃ‰PARTITION PAR PAYS:"
          tail -n +2 "$latest_csv" | cut -d',' -f9 | sort | uniq -c | sort -nr
          
          # VÃ©rifier rÃ©partition par type
          echo ""
          echo "ğŸ¯ RÃ‰PARTITION PAR TYPE:"
          tail -n +2 "$latest_csv" | cut -d',' -f1 | sort | uniq -c | sort -nr
        fi
        
    - name: ğŸ“¦ Upload Results as Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: afrique-leads-run-${{ github.run_number }}
        path: |
          data/*.csv
          data/*.json
        retention-days: 30
        if-no-files-found: warn
        
    - name: ğŸ‰ RÃ©sumÃ© Final
      if: always()
      run: |
        echo ""
        echo "ğŸ‰ =========================================="
        echo "ğŸŒ SCRAPING AFRIQUE TERMINÃ‰ - RUN #${{ github.run_number }}"
        echo "ğŸ‰ =========================================="
        echo "ğŸ“… Date fin: $(date)"
        echo "ğŸš« Automation email: DÃ‰SACTIVÃ‰E"
        echo "âœ… Scraping seul: ACTIVÃ‰"
        echo "ğŸ“Š DonnÃ©es disponibles dans les Artifacts"
        echo ""
        
        # Status final
        if [ -f "data/afrique_8_cibles_run${{ github.run_number }}_"*.csv ]; then
          echo "âœ… SUCCÃˆS: Fichiers CSV gÃ©nÃ©rÃ©s"
        else
          echo "âŒ Ã‰CHEC: Aucun CSV gÃ©nÃ©rÃ©"
        fi
